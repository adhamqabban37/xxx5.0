# ===================================
# XENLIX AEO PLATFORM - MAKEFILE
# One-command Docker deployment for production
# ===================================

.PHONY: help up down logs health build clean restart status test

# Default target
.DEFAULT_GOAL := help

# Colors for output
RED=\033[0;31m
GREEN=\033[0;32m
YELLOW=\033[0;33m
BLUE=\033[0;34m
MAGENTA=\033[0;35m
CYAN=\033[0;36m
NC=\033[0m # No Color

# Docker Compose command
DOCKER_COMPOSE=docker-compose

# ===================================
# MAIN COMMANDS
# ===================================

## ğŸš€ Start all services (main command)
up:
	@echo "${GREEN}ğŸš€ Starting Xenlix AEO Platform...${NC}"
	@echo "${YELLOW}ğŸ“‹ Checking prerequisites...${NC}"
	@$(MAKE) check-env
	@$(MAKE) check-docker
	@echo "${BLUE}ğŸ—ï¸  Building and starting services...${NC}"
	$(DOCKER_COMPOSE) up --build -d
	@echo "${GREEN}âœ… Services started! Waiting for health checks...${NC}"
	@sleep 10
	@$(MAKE) health
	@$(MAKE) status
	@echo "${GREEN}ğŸ‰ Xenlix AEO Platform is running!${NC}"
	@echo "${CYAN}ğŸ“Š Access URLs:${NC}"
	@echo "   ğŸŒ Main App:     http://localhost:3000"
	@echo "   ğŸ•¸ï¸  Crawl4AI:    http://localhost:8001"
	@echo "   ğŸ—„ï¸  Redis:       localhost:6379"
	@echo "   ğŸ“Š Health Check: http://localhost:3000/api/health"

## ğŸ›‘ Stop all services
down:
	@echo "${RED}ğŸ›‘ Stopping Xenlix AEO Platform...${NC}"
	$(DOCKER_COMPOSE) down
	@echo "${GREEN}âœ… All services stopped${NC}"

## ğŸ“‹ Show service logs
logs:
	@echo "${BLUE}ğŸ“‹ Showing service logs...${NC}"
	$(DOCKER_COMPOSE) logs -f --tail=100

## ğŸ¥ Check health status
health:
	@echo "${BLUE}ğŸ¥ Checking service health...${NC}"
	@echo "${YELLOW}Redis:${NC}"
	@docker exec xenlix-redis redis-cli ping 2>/dev/null || echo "${RED}âŒ Redis unhealthy${NC}"
	@echo "${YELLOW}Crawl4AI:${NC}"
	@curl -sf http://localhost:8001/health >/dev/null && echo "${GREEN}âœ… Crawl4AI healthy${NC}" || echo "${RED}âŒ Crawl4AI unhealthy${NC}"
	@echo "${YELLOW}Main App:${NC}"
	@curl -sf http://localhost:3000/api/health >/dev/null && echo "${GREEN}âœ… App healthy${NC}" || echo "${RED}âŒ App unhealthy${NC}"

## ğŸ—ï¸ Build services without starting
build:
	@echo "${BLUE}ğŸ—ï¸  Building Docker images...${NC}"
	$(DOCKER_COMPOSE) build

## ğŸ§¹ Clean up containers, images, and volumes
clean:
	@echo "${RED}ğŸ§¹ Cleaning up Docker resources...${NC}"
	$(DOCKER_COMPOSE) down -v --rmi all --remove-orphans
	@docker system prune -f
	@echo "${GREEN}âœ… Cleanup complete${NC}"

## ğŸ”„ Restart all services
restart:
	@echo "${YELLOW}ğŸ”„ Restarting services...${NC}"
	@$(MAKE) down
	@sleep 5
	@$(MAKE) up

## ğŸ“Š Show service status
status:
	@echo "${BLUE}ğŸ“Š Service Status:${NC}"
	@$(DOCKER_COMPOSE) ps

## ğŸ§ª Run end-to-end test
test:
	@echo "${BLUE}ğŸ§ª Running end-to-end tests...${NC}"
	@echo "${YELLOW}Testing health endpoints...${NC}"
	@$(MAKE) health
	@echo "${YELLOW}Testing AEO analysis...${NC}"
	@curl -X POST http://localhost:3000/api/aeo-score \
		-H "Content-Type: application/json" \
		-d '{"url":"https://example.com","queries":["What services do you offer?"]}' \
		-w "\nResponse Code: %{http_code}\n" || echo "${RED}âŒ AEO test failed${NC}"
	@echo "${GREEN}âœ… End-to-end test complete${NC}"

# ===================================
# DEVELOPMENT COMMANDS
# ===================================

## ğŸ”§ Start in development mode
dev:
	@echo "${GREEN}ğŸ”§ Starting development environment...${NC}"
	$(DOCKER_COMPOSE) -f docker-compose.yml -f docker-compose.dev.yml up --build

## ğŸ› Debug - attach to running containers
debug:
	@echo "${MAGENTA}ğŸ› Available containers for debugging:${NC}"
	@$(DOCKER_COMPOSE) ps
	@echo "${YELLOW}To attach to a container:${NC}"
	@echo "  docker exec -it xenlix-app sh"
	@echo "  docker exec -it xenlix-crawl4ai sh"
	@echo "  docker exec -it xenlix-redis sh"

## ğŸ“Š Start with monitoring stack
monitor:
	@echo "${GREEN}ğŸ“Š Starting with monitoring...${NC}"
	$(DOCKER_COMPOSE) --profile monitoring up -d
	@echo "${CYAN}Monitoring URLs:${NC}"
	@echo "   ğŸ“Š Prometheus: http://localhost:9090"
	@echo "   ğŸ“ˆ Grafana:    http://localhost:3001"

## ğŸ—„ï¸ Start with PostgreSQL
postgres:
	@echo "${GREEN}ğŸ—„ï¸  Starting with PostgreSQL...${NC}"
	$(DOCKER_COMPOSE) --profile postgres up -d

# ===================================
# UTILITY COMMANDS
# ===================================

## ğŸ” Check prerequisites
check-env:
	@echo "${BLUE}ğŸ” Checking environment file...${NC}"
	@if [ ! -f .env ]; then \
		echo "${RED}âŒ .env file not found. Creating from template...${NC}"; \
		cp .env.example .env; \
		echo "${YELLOW}âš ï¸  Please edit .env file with your actual values${NC}"; \
		echo "${YELLOW}   Required: HUGGINGFACE_API_TOKEN, FIREBASE_*, NEXTAUTH_SECRET${NC}"; \
	else \
		echo "${GREEN}âœ… .env file found${NC}"; \
	fi

## ğŸ³ Check Docker availability
check-docker:
	@echo "${BLUE}ğŸ³ Checking Docker...${NC}"
	@docker --version >/dev/null 2>&1 || (echo "${RED}âŒ Docker not installed${NC}" && exit 1)
	@docker-compose --version >/dev/null 2>&1 || (echo "${RED}âŒ Docker Compose not installed${NC}" && exit 1)
	@echo "${GREEN}âœ… Docker is available${NC}"

## ğŸ“Š Show resource usage
stats:
	@echo "${BLUE}ğŸ“Š Container resource usage:${NC}"
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"

## ğŸ“ Show logs for specific service
logs-%:
	@echo "${BLUE}ğŸ“ Showing logs for $*...${NC}"
	@$(DOCKER_COMPOSE) logs -f --tail=100 $*

## ğŸ”„ Restart specific service  
restart-%:
	@echo "${YELLOW}ğŸ”„ Restarting $*...${NC}"
	@$(DOCKER_COMPOSE) restart $*

# ===================================
# HELP
# ===================================

## ğŸ“š Show this help message
help:
	@echo "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
	@echo "${CYAN}â•‘                    XENLIX AEO PLATFORM                  â•‘${NC}"
	@echo "${CYAN}â•‘                   Docker Deployment                     â•‘${NC}"
	@echo "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
	@echo ""
	@echo "${GREEN}ğŸš€ QUICK START:${NC}"
	@echo "   ${YELLOW}make up${NC}     - Start all services (main command)"
	@echo ""
	@echo "${BLUE}ğŸ“‹ MAIN COMMANDS:${NC}"
	@awk 'BEGIN {FS = ":.*?## "}; /^[a-zA-Z_-]+:.*?## / {printf "   ${YELLOW}make %-12s${NC} - %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "${MAGENTA}ğŸ”§ DEVELOPMENT:${NC}"
	@echo "   ${YELLOW}make dev${NC}      - Start in development mode"
	@echo "   ${YELLOW}make debug${NC}    - Show debug information"
	@echo "   ${YELLOW}make monitor${NC}  - Start with monitoring stack"
	@echo "   ${YELLOW}make postgres${NC} - Start with PostgreSQL"
	@echo ""
	@echo "${CYAN}ğŸ“Š MONITORING:${NC}"
	@echo "   ${YELLOW}make stats${NC}    - Show resource usage"
	@echo "   ${YELLOW}make logs-app${NC} - Show app logs"
	@echo "   ${YELLOW}make logs-crawl4ai${NC} - Show crawl4ai logs"
	@echo ""
	@echo "${GREEN}ğŸ¯ EXAMPLE WORKFLOW:${NC}"
	@echo "   1. ${YELLOW}cp .env.example .env${NC}"
	@echo "   2. ${YELLOW}# Edit .env with your API keys${NC}"
	@echo "   3. ${YELLOW}make up${NC}"
	@echo "   4. ${YELLOW}make test${NC}"
	@echo "   5. ${YELLOW}# Visit http://localhost:3000${NC}"