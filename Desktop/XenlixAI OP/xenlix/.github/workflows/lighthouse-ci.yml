name: Lighthouse CI

on: 
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lhci:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ðŸ“‹ Checkout
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ”§ Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            chromium \
            libnss3 \
            libatk-bridge2.0-0 \
            libdrm2 \
            libxkbcommon0 \
            libgbm1 \
            libasound2

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”¨ Build application
        run: npm run build

      - name: ðŸš€ Start server and run LHCI
        run: |
          npm run start &
          sleep 15
          # Wait for server to be ready
          timeout 60s bash -c 'until curl -f http://localhost:3000 2>/dev/null; do sleep 2; done'
          
          # Run Lighthouse CI
          npx lhci autorun
        env:
          CHROME_PATH: /usr/bin/chromium
          NODE_ENV: production

      - name: ðŸ“ Upload LHCI reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lhci-reports-${{ github.run_id }}
          path: |
            lhci_reports/
            .lighthouseci/
          retention-days: 30

      - name: ðŸ“Š Comment PR with Lighthouse results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              // Look for LHCI results
              const reportsDir = './lhci_reports';
              if (fs.existsSync(reportsDir)) {
                const files = fs.readdirSync(reportsDir);
                const jsonFiles = files.filter(f => f.endsWith('.json'));
                
                if (jsonFiles.length > 0) {
                  const reportPath = path.join(reportsDir, jsonFiles[0]);
                  const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                  
                  const scores = {
                    performance: Math.round(report.categories?.performance?.score * 100) || 0,
                    accessibility: Math.round(report.categories?.accessibility?.score * 100) || 0,
                    seo: Math.round(report.categories?.seo?.score * 100) || 0,
                    'best-practices': Math.round(report.categories?.['best-practices']?.score * 100) || 0
                  };
                  
                  const body = `## ðŸ” Lighthouse CI Results
            
            | Category | Score |
            |----------|-------|
            | ðŸš€ Performance | ${scores.performance}% |
            | â™¿ Accessibility | ${scores.accessibility}% |
            | ðŸ” SEO | ${scores.seo}% |
            | âœ… Best Practices | ${scores['best-practices']}% |
            
            ${scores.performance >= 90 ? 'ðŸŽ‰' : scores.performance >= 75 ? 'âš ï¸' : 'âŒ'} **Performance**: ${scores.performance >= 90 ? 'Excellent' : scores.performance >= 75 ? 'Needs improvement' : 'Poor'}
            ${scores.seo >= 90 ? 'ðŸŽ‰' : 'âŒ'} **SEO**: ${scores.seo >= 90 ? 'Excellent' : 'Needs improvement'}
            
            [View detailed report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
                  
                  github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: body
                  });
                }
              }
            } catch (error) {
              console.log('Could not parse Lighthouse report:', error);
            }